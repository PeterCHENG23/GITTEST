#!pip install dash plotly yfinance pandas numpy
#å¦‚æœå¡ç’°å¢ƒå¯ä»¥è£

#from google.colab import files
#uploaded = files.upload()

import pandas as pd
import dash
from dash import dcc, html, callback
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import yfinance as yf
import numpy as np
from plotly.subplots import make_subplots
import os

# å®‰è£å¿…è¦å¥—ä»¶ (åœ¨ Colab ä¸­åŸ·è¡Œ)
# !pip install dash plotly yfinance pandas numpy

# å°è‚¡ä»£è™Ÿå°æ‡‰è¡¨
TAIWAN_STOCKS = {
    'å°æŒ‡æœŸ': 'TXF=F',  # å°æŒ‡æœŸè²¨
    'å°ç©é›»': '2330.TW',
    'è¯ç™¼ç§‘': '2454.TW',
    'é´»æµ·': '2317.TW',
    'å°å¡‘': '1301.TW',
    'ä¸­è¯é›»': '2412.TW',
    'å¯Œé‚¦é‡‘': '2881.TW',
    'åœ‹æ³°é‡‘': '2882.TW',
    'å°é”é›»': '2308.TW',
    'çµ±ä¸€': '1216.TW',
    'æ—¥æœˆå…‰': '2311.TW',
    'é•·æ¦®': '2306.TW',
    'æ…§æ´‹-KY': '2637.TW',
    'ä¸ŠéŠ€' : '2049.TW',
    'å°æ³¥' : '1101.TW',
    'è­œç‘-KY' :'4966.TW',
    'è²¿è¯-KY' :'3665.TW'
}

# ç”¢æ¥­åˆ†é¡
INDUSTRY_MAPPING = {
    '2330.TW': 'åŠå°é«”',
    '2454.TW': 'åŠå°é«”',
    '2317.TW': 'é›»å­çµ„ä»¶',
    '1301.TW': 'å¡‘è† ',
    '2412.TW': 'é›»ä¿¡',
    '2881.TW': 'é‡‘è',
    '2882.TW': 'é‡‘è',
    '2308.TW': 'é›»å­',
    '1216.TW': 'é£Ÿå“',
    '2311.TW': 'åŠå°é«”',
    '2306.TW': 'èˆªé‹',
    '2637.TW': 'æ•£è£èˆªé‹',
    '2049.TW' : 'å·¥å…·æ©Ÿ',
    '1101.TW' : 'ç‡Ÿå»º',
    '4966.TW' :'é«˜é€Ÿå‚³è¼¸',
    '3665.TW' :'é€£æ¥å™¨'
}

def get_stock_data(symbol, period='1y'):
    """ç²å–è‚¡ç¥¨è³‡æ–™"""
    try:
        stock = yf.Ticker(symbol)
        data = stock.history(period=period)

        # å¦‚æœå°æŒ‡æœŸè³‡æ–™ç‚ºç©ºï¼Œå˜—è©¦æ›¿ä»£æ–¹æ¡ˆ
        if data.empty and symbol == 'TXF=F':
            # å˜—è©¦ä½¿ç”¨å°ç£50ETFä½œç‚ºæ›¿ä»£
            stock = yf.Ticker('0050.TW')
            data = stock.history(period=period)
            if data.empty:
                # æœ€å¾Œå˜—è©¦ä½¿ç”¨åŠ æ¬ŠæŒ‡æ•¸
                stock = yf.Ticker('^TWII')
                data = stock.history(period=period)

        return data
    except:
        return pd.DataFrame()

def create_lstm_dataset(data, time_step=60):
    """å»ºç«‹LSTMè¨“ç·´è³‡æ–™é›†"""
    X, y = [], []
    for i in range(time_step, len(data)):
        X.append(data[i-time_step:i, 0])
        y.append(data[i, 0])
    return np.array(X), np.array(y)

def simple_lstm_predict(data, predict_days=5):
    """ç°¡åŒ–çš„LSTMé æ¸¬æ¨¡å‹ (ä½¿ç”¨çµ±è¨ˆæ–¹æ³•æ¨¡æ“¬)"""
    if len(data) < 60:
        return None

    # ä½¿ç”¨ç§»å‹•å¹³å‡å’Œè¶¨å‹¢åˆ†æä¾†æ¨¡æ“¬æ·±åº¦å­¸ç¿’é æ¸¬
    prices = data['Close'].values

    # è¨ˆç®—çŸ­æœŸå’Œé•·æœŸç§»å‹•å¹³å‡
    ma_short = np.mean(prices[-5:])
    ma_medium = np.mean(prices[-20:])
    ma_long = np.mean(prices[-60:])

    # è¨ˆç®—åƒ¹æ ¼è®ŠåŒ–è¶¨å‹¢
    recent_trend = np.polyfit(range(20), prices[-20:], 1)[0]
    volatility = np.std(prices[-20:]) / np.mean(prices[-20:])

    # æ¨¡æ“¬é æ¸¬é‚è¼¯
    base_change = recent_trend * predict_days
    trend_factor = 1.0

    if ma_short > ma_medium > ma_long:
        trend_factor = 1.02  # ä¸Šå‡è¶¨å‹¢
    elif ma_short < ma_medium < ma_long:
        trend_factor = 0.98  # ä¸‹é™è¶¨å‹¢
    else:
        trend_factor = 1.0   # ç›¤æ•´

    # åŠ å…¥éš¨æ©Ÿæ€§æ¨¡æ“¬å¸‚å ´ä¸ç¢ºå®šæ€§
    noise_factor = np.random.normal(1, volatility * 0.1)

    predicted_price = prices[-1] * trend_factor + base_change + (prices[-1] * noise_factor * 0.01)
    change_pct = ((predicted_price - prices[-1]) / prices[-1]) * 100

    return {
        'predicted_price': predicted_price,
        'change_pct': change_pct,
        'confidence': max(0.6, 1 - volatility * 2)  # åŸºæ–¼æ³¢å‹•ç‡çš„ä¿¡å¿ƒåº¦
    }

def calculate_technical_indicators(df):
    """è¨ˆç®—æŠ€è¡“æŒ‡æ¨™"""
    if df.empty:
        return df

    # ç§»å‹•å¹³å‡ç·š
    df['MA5'] = df['Close'].rolling(window=5).mean()
    df['MA20'] = df['Close'].rolling(window=20).mean()

    # RSI
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # MACD (12, 26, 9)
    exp1 = df['Close'].ewm(span=12).mean()
    exp2 = df['Close'].ewm(span=26).mean()
    df['MACD'] = exp1 - exp2
    df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()
    df['MACD_Histogram'] = df['MACD'] - df['MACD_Signal']

    # å¸ƒæ—é€šé“ (20æ—¥, 2å€æ¨™æº–å·®)
    df['BB_Middle'] = df['Close'].rolling(window=20).mean()
    bb_std = df['Close'].rolling(window=20).std()
    df['BB_Upper'] = df['BB_Middle'] + (bb_std * 2)
    df['BB_Lower'] = df['BB_Middle'] - (bb_std * 2)
    df['BB_Width'] = df['BB_Upper'] - df['BB_Lower']
    df['BB_Position'] = (df['Close'] - df['BB_Lower']) / (df['BB_Upper'] - df['BB_Lower'])

    # KDæŒ‡æ¨™ (9, 3, 3)
    low_min = df['Low'].rolling(window=9).min()
    high_max = df['High'].rolling(window=9).max()
    rsv = (df['Close'] - low_min) / (high_max - low_min) * 100
    df['K'] = rsv.ewm(com=2).mean()  # com=2 ç›¸ç•¶æ–¼ span=3
    df['D'] = df['K'].ewm(com=2).mean()

    # å¨å»‰æŒ‡æ¨™ %R (14æ—¥)
    low_min_14 = df['Low'].rolling(window=14).min()
    high_max_14 = df['High'].rolling(window=14).max()
    df['Williams_R'] = -100 * (high_max_14 - df['Close']) / (high_max_14 - low_min_14)

    return df

def get_business_climate_data():
    """ç²å–å°ç£æ™¯æ°£ç‡ˆè™Ÿè³‡æ–™"""
    try:
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        if not os.path.exists('business_climate.csv'):
            print("business_climate.csv æª”æ¡ˆä¸å­˜åœ¨")
            return pd.DataFrame()

        # è®€å–CSVæª”æ¡ˆï¼Œå‡è¨­åˆ—åç‚º Date å’Œ Index
        df = pd.read_csv('business_climate.csv')

        # æª¢æŸ¥åˆ—åä¸¦èª¿æ•´
        if 'Date' not in df.columns:
            # å¦‚æœç¬¬ä¸€åˆ—æ˜¯æ—¥æœŸï¼Œé‡æ–°å‘½å
            df.columns = ['Date', 'Index'] if len(df.columns) == 2 else df.columns

        # è½‰æ›æ—¥æœŸæ ¼å¼ (è™•ç† YYYY-MM æ ¼å¼)
        if 'Date' in df.columns:
            try:
                # å¦‚æœæ˜¯ YYYY-MM æ ¼å¼ï¼Œè½‰æ›ç‚ºæ—¥æœŸ
                df['Date'] = pd.to_datetime(df['Date'] + '-01', format='%Y-%m-%d', errors='coerce')
            except:
                df['Date'] = pd.to_datetime(df['Date'], errors='coerce')

        # ç§»é™¤æ—¥æœŸè½‰æ›å¤±æ•—çš„è¡Œ
        df = df.dropna(subset=['Date'])

        print(f"æˆåŠŸè®€å–æ™¯æ°£ç‡ˆè™Ÿè³‡æ–™ï¼š{len(df)} ç­†è¨˜éŒ„")
        return df

    except Exception as e:
        print(f"ç„¡æ³•ç²å–æ™¯æ°£ç‡ˆè™Ÿè³‡æ–™: {str(e)}")
        return pd.DataFrame()

def get_pmi_data():
    """ç²å–å°ç£ PMI è³‡æ–™"""
    try:
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        if not os.path.exists('taiwan_pmi.csv'):
            print("taiwan_pmi.csv æª”æ¡ˆä¸å­˜åœ¨")
            return pd.DataFrame()

        # è®€å–CSVæª”æ¡ˆ
        df = pd.read_csv('taiwan_pmi.csv')

        # æª¢æŸ¥åˆ—åä¸¦èª¿æ•´ (è™•ç† DATE/INDEX æˆ–å…¶ä»–å¯èƒ½çš„åˆ—å)
        if 'DATE' in df.columns:
            df = df.rename(columns={'DATE': 'Date', 'INDEX': 'Index'})
        elif len(df.columns) == 2:
            df.columns = ['Date', 'Index']

        # è½‰æ›æ—¥æœŸæ ¼å¼
        if 'Date' in df.columns:
            try:
                # å¦‚æœæ˜¯ YYYY-MM æ ¼å¼ï¼Œè½‰æ›ç‚ºæ—¥æœŸ
                df['Date'] = pd.to_datetime(df['Date'] + '-01', format='%Y-%m-%d', errors='coerce')
            except:
                df['Date'] = pd.to_datetime(df['Date'], errors='coerce')

        # ç§»é™¤æ—¥æœŸè½‰æ›å¤±æ•—çš„è¡Œ
        df = df.dropna(subset=['Date'])

        print(f"æˆåŠŸè®€å– PMI è³‡æ–™ï¼š{len(df)} ç­†è¨˜éŒ„")
        return df

    except Exception as e:
        print(f"ç„¡æ³•ç²å– PMI è³‡æ–™: {str(e)}")
        return pd.DataFrame()

# å»ºç«‹ Dash æ‡‰ç”¨ç¨‹å¼
app = dash.Dash(__name__, suppress_callback_exceptions=True)

# æ‡‰ç”¨ç¨‹å¼ä½ˆå±€
app.layout = html.Div([
    html.H1("å°è‚¡åˆ†æå„€è¡¨æ¿", style={'text-align': 'center', 'margin-bottom': '30px'}),

    # æ§åˆ¶é¢æ¿
    html.Div([
        html.Div([
            html.Label("é¸æ“‡è‚¡ç¥¨:"),
            dcc.Dropdown(
                id='stock-dropdown',
                options=[{'label': name, 'value': symbol} for name, symbol in TAIWAN_STOCKS.items()],
                value='TXF=F',
                style={'margin-bottom': '10px'}
            )
        ], style={'width': '30%', 'display': 'inline-block', 'vertical-align': 'top'}),

        html.Div([
            html.Label("æ™‚é–“ç¯„åœ:"),
            dcc.Dropdown(
                id='period-dropdown',
                options=[
                    {'label': '1å€‹æœˆ', 'value': '1mo'},
                    {'label': '3å€‹æœˆ', 'value': '3mo'},
                    {'label': '6å€‹æœˆ', 'value': '6mo'},
                    {'label': '1å¹´', 'value': '1y'},
                    {'label': '2å¹´', 'value': '2y'}
                ],
                value='6mo',
                style={'margin-bottom': '10px'}
            )
        ], style={'width': '30%', 'display': 'inline-block', 'margin-left': '5%', 'vertical-align': 'top'}),

        html.Div([
            html.Label("åœ–è¡¨é¡å‹:"),
            dcc.Dropdown(
                id='chart-type',
                options=[
                    {'label': 'ç·šåœ–', 'value': 'line'},
                    {'label': 'è Ÿç‡­åœ–', 'value': 'candlestick'}
                ],
                value='candlestick',
                style={'margin-bottom': '10px'}
            )
        ], style={'width': '30%', 'display': 'inline-block', 'margin-left': '5%', 'vertical-align': 'top'})
    ], style={'margin-bottom': '30px'}),

    # è‚¡åƒ¹è³‡è¨Šå¡ç‰‡
    html.Div(id='stock-info-cards', style={'margin-bottom': '30px'}),

    # AIé æ¸¬å€å¡Š (åªåœ¨é¸æ“‡å°æŒ‡æœŸæ™‚é¡¯ç¤º)
    html.Div(id='prediction-section', style={'margin-bottom': '30px'}),

    # ä¸»è¦åœ–è¡¨å€åŸŸ
    html.Div([
        # å·¦å´ï¼šè‚¡åƒ¹èµ°å‹¢åœ–å’ŒæŠ€è¡“æŒ‡æ¨™
        html.Div([
            html.Div([
                dcc.Graph(id='price-chart')
            ], style={'margin-bottom': '20px'}),

            html.Div([
                dcc.Graph(id='rsi-chart')
            ])
        ], style={'width': '65%', 'display': 'inline-block', 'vertical-align': 'top'}),

        # å³å´ï¼šåˆ†æè³‡è¨Šé¢æ¿
        html.Div([
            html.Div(id='analysis-panel')
        ], style={'width': '33%', 'display': 'inline-block', 'margin-left': '2%', 'vertical-align': 'top'})
    ]),

    # æŠ€è¡“æŒ‡æ¨™é¸æ“‡å€åŸŸ
    html.Div([
        html.H3("ğŸ“Š é€²éšæŠ€è¡“æŒ‡æ¨™åˆ†æ", style={'margin-bottom': '20px'}),
        html.Div([
            html.Label("é¸æ“‡æŠ€è¡“æŒ‡æ¨™:", style={'font-weight': 'bold', 'margin-right': '10px'}),
            dcc.Dropdown(
                id='technical-indicator-selector',
                options=[
                    {'label': 'RSI ç›¸å°å¼·å¼±æŒ‡æ¨™', 'value': 'RSI'},
                    {'label': 'MACD æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š', 'value': 'MACD'},
                    {'label': 'å¸ƒæ—é€šé“ Bollinger Bands', 'value': 'BB'},
                    {'label': 'KD éš¨æ©ŸæŒ‡æ¨™', 'value': 'KD'},
                    {'label': 'å¨å»‰æŒ‡æ¨™ %R', 'value': 'WR'}
                ],
                value='RSI',
                style={'width': '100%'}
            )
        ], style={'margin-bottom': '20px'}),

        html.Div([
            dcc.Graph(id='advanced-technical-chart')
        ])
    ], style={
        'margin-top': '20px',
        'padding': '20px',
        'background': 'white',
        'border-radius': '10px',
        'box-shadow': '0 2px 10px rgba(0,0,0,0.1)'
    }),

    # æˆäº¤é‡åœ–
    html.Div([
        dcc.Graph(id='volume-chart')
    ], style={'margin-top': '20px'}),

    # ç”¢æ¥­åˆ†æ
    html.Div([
        html.H3("ç”¢æ¥­è¡¨ç¾åˆ†æ"),
        dcc.Graph(id='industry-analysis')
    ], style={'margin-top': '30px'}),

    # åˆ†æå¸«è§€é»å€åŸŸ
    html.Div([
        html.H3("ğŸ“Š åˆ†æå¸«è§€é»èˆ‡å¸‚å ´è§£è®€", style={'color': '#2E86AB', 'margin-bottom': '20px'}),
        html.Div([
            # å·¦å´ï¼šæŠ€è¡“åˆ†æè§€é»
            html.Div([
                html.H4("ğŸ” æŠ€è¡“é¢åˆ†æ", style={'color': '#A23B72', 'margin-bottom': '15px'}),
                html.Div(id='technical-analysis-text', style={
                    'background': '#f8f9fa',
                    'padding': '15px',
                    'border-radius': '8px',
                    'border-left': '4px solid #A23B72',
                    'min-height': '150px',
                    'font-size': '14px',
                    'line-height': '1.6'
                })
            ], style={'width': '48%', 'display': 'inline-block', 'vertical-align': 'top'}),

            # å³å´ï¼šåŸºæœ¬é¢åˆ†æè§€é»
            html.Div([
                html.H4("ğŸ“ˆ åŸºæœ¬é¢åˆ†æ", style={'color': '#F18F01', 'margin-bottom': '15px'}),
                html.Div(id='fundamental-analysis-text', style={
                    'background': '#f8f9fa',
                    'padding': '15px',
                    'border-radius': '8px',
                    'border-left': '4px solid #F18F01',
                    'min-height': '150px',
                    'font-size': '14px',
                    'line-height': '1.6'
                })
            ], style={'width': '48%', 'display': 'inline-block', 'margin-left': '4%', 'vertical-align': 'top'})
        ]),

        # åº•éƒ¨ï¼šå¸‚å ´å±•æœ›
        html.Div([
            html.H4("ğŸ¯ å¸‚å ´å±•æœ›èˆ‡æŠ•è³‡å»ºè­°", style={'color': '#C73E1D', 'margin-bottom': '15px', 'margin-top': '25px'}),
            html.Div(id='market-outlook-text', style={
                'background': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'color': 'white',
                'padding': '20px',
                'border-radius': '10px',
                'min-height': '100px',
                'font-size': '15px',
                'line-height': '1.7',
                'box-shadow': '0 4px 15px rgba(0,0,0,0.1)'
            })
        ])
    ], style={
        'margin-top': '30px',
        'padding': '25px',
        'background': 'white',
        'border-radius': '12px',
        'box-shadow': '0 4px 20px rgba(0,0,0,0.08)',
        'border': '1px solid #e9ecef'
    }),

    # æ™¯æ°£ç‡ˆè™Ÿèˆ‡ PMI åˆ†æ
    html.Div([
        html.H3("æ™¯æ°£ç‡ˆè™Ÿèˆ‡ PMI åˆ†æ"),
        html.Div([
            html.Div([
                dcc.Graph(id='business-climate-chart')
            ], style={'width': '48%', 'display': 'inline-block'}),
            html.Div([
                dcc.Graph(id='pmi-chart')
            ], style={'width': '48%', 'display': 'inline-block', 'margin-left': '2%'})
        ])
    ], style={'margin-top': '30px'}),

    # å¤šæª”è‚¡ç¥¨æ¯”è¼ƒå€åŸŸ
    html.Div([
        html.H3("ğŸ“Š å¤šæª”è‚¡ç¥¨æ¯”è¼ƒåˆ†æ", style={'margin-bottom': '20px'}),
        html.Div([
            html.Div([
                html.Label("é¸æ“‡æ¯”è¼ƒè‚¡ç¥¨ï¼ˆæœ€å¤š5æª”ï¼‰:", style={'font-weight': 'bold'}),
                dcc.Dropdown(
                    id='comparison-stocks',
                    options=[{'label': name, 'value': symbol} for name, symbol in TAIWAN_STOCKS.items()],
                    value=['2330.TW', '2454.TW', '2317.TW'],  # é è¨­é¸æ“‡
                    multi=True,
                    style={'margin-bottom': '15px'}
                )
            ], style={'width': '60%', 'display': 'inline-block'}),

            html.Div([
                html.Label("æ¯”è¼ƒæœŸé–“:", style={'font-weight': 'bold'}),
                dcc.Dropdown(
                    id='comparison-period',
                    options=[
                        {'label': '1å€‹æœˆ', 'value': '1mo'},
                        {'label': '3å€‹æœˆ', 'value': '3mo'},
                        {'label': '6å€‹æœˆ', 'value': '6mo'},
                        {'label': '1å¹´', 'value': '1y'}
                    ],
                    value='3mo'
                )
            ], style={'width': '35%', 'display': 'inline-block', 'margin-left': '5%'})
        ]),

        html.Div([
            html.Div([
                dcc.Graph(id='comparison-chart')
            ], style={'width': '65%', 'display': 'inline-block'}),

            html.Div([
                html.H4("æ¯”è¼ƒçµæœ", style={'color': '#2E86AB'}),
                html.Div(id='comparison-table')
            ], style={'width': '33%', 'display': 'inline-block', 'margin-left': '2%', 'vertical-align': 'top'})
        ])
    ], style={
        'margin-top': '30px',
        'padding': '20px',
        'background': 'white',
        'border-radius': '10px',
        'box-shadow': '0 2px 10px rgba(0,0,0,0.1)'
    }),

    # æ–°èæƒ…æ„Ÿåˆ†æå€åŸŸï¼ˆæ¨¡æ“¬ï¼‰
    html.Div([
        html.H3("ğŸ“° å¸‚å ´æƒ…ç·’èˆ‡æ–°èåˆ†æ", style={'color': '#E74C3C', 'margin-bottom': '20px'}),
        html.Div([
            html.Div([
                html.H4("å¸‚å ´æƒ…ç·’æŒ‡æ¨™", style={'color': '#8E44AD'}),
                html.Div(id='sentiment-gauge')
            ], style={'width': '48%', 'display': 'inline-block'}),

            html.Div([
                html.H4("é—œéµæ–°èæ‘˜è¦", style={'color': '#27AE60'}),
                html.Div(id='news-summary', style={
                    'background': '#f8f9fa',
                    'padding': '15px',
                    'border-radius': '8px',
                    'max-height': '200px',
                    'overflow-y': 'auto'
                })
            ], style={'width': '48%', 'display': 'inline-block', 'margin-left': '4%'})
        ])
    ], style={
        'margin-top': '30px',
        'padding': '20px',
        'background': 'white',
        'border-radius': '10px',
        'box-shadow': '0 2px 10px rgba(0,0,0,0.1)'
    })
])

# æ›´æ–°AIé æ¸¬å€å¡Š
@app.callback(
    dash.dependencies.Output('prediction-section', 'children'),
    [dash.dependencies.Input('stock-dropdown', 'value')],
    prevent_initial_call=False
)
def update_prediction_section(selected_stock):
    if selected_stock != 'TXF=F':
        return html.Div()  # åªåœ¨é¸æ“‡å°æŒ‡æœŸæ™‚é¡¯ç¤ºé æ¸¬åŠŸèƒ½

    return html.Div([
        html.H3("ğŸ¤– AIæ·±åº¦å­¸ç¿’é æ¸¬ - å°æŒ‡æœŸæŒ‡æ•¸", style={'text-align': 'center', 'color': '#FFCC22'}),
        html.Div([
            html.Div([
                html.Label("é æ¸¬æœŸé–“:", style={'font-weight': 'bold', 'color': '#FFCC22'}),
                dcc.Dropdown(
                    id='prediction-period',
                    options=[
                        {'label': '5æ—¥å¾Œé æ¸¬', 'value': 5},
                        {'label': '10æ—¥å¾Œé æ¸¬', 'value': 10},
                        {'label': '20æ—¥å¾Œé æ¸¬', 'value': 20},
                        {'label': '60æ—¥å¾Œé æ¸¬', 'value': 60}
                    ],
                    value=5,
                    style={'margin-bottom': '10px', 'color': '#272727'}
                )
            ], style={'width': '30%', 'display': 'inline-block'}),

            html.Div(id='prediction-results', style={'width': '65%', 'display': 'inline-block', 'margin-left': '5%'})
        ]),

        html.Div([
            dcc.Graph(id='prediction-chart')
        ], style={'margin-top': '20px'})
    ], style={
        'background': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'padding': '25px',
        'border-radius': '15px',
        'box-shadow': '0 8px 25px rgba(0,0,0,0.15)',
        'color': 'white'
    })

# æ›´æ–°é æ¸¬çµæœ
@app.callback(
    [dash.dependencies.Output('prediction-results', 'children'),
     dash.dependencies.Output('prediction-chart', 'figure')],
    [dash.dependencies.Input('prediction-period', 'value'),
     dash.dependencies.Input('stock-dropdown', 'value')]
)
def update_prediction(predict_days, selected_stock):
    if selected_stock != 'TXF=F':
        return html.Div(), {}

    # ç²å–å°æŒ‡æœŸæ­·å²è³‡æ–™
    data = get_stock_data('^TWII', '2y')
    if data.empty:
        return html.Div("ç„¡æ³•ç²å–å°æŒ‡æœŸè³‡æ–™"), {}

    # åŸ·è¡Œé æ¸¬
    prediction = simple_lstm_predict(data, predict_days)
    if prediction is None:
        return html.Div("è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œé æ¸¬"), {}

    current_price = data['Close'].iloc[-1]
    predicted_price = prediction['predicted_price']
    change_pct = prediction['change_pct']
    confidence = prediction['confidence']

    # é æ¸¬çµæœå¡ç‰‡
    color = '#00C851' if change_pct >= 0 else '#FF4444'
    arrow = 'ğŸ“ˆ' if change_pct >= 0 else 'ğŸ“‰'

    result_card = html.Div([
        html.H4(f"{predict_days}æ—¥å¾Œé æ¸¬çµæœ", style={'margin': '0 0 15px 0', 'color': 'white'}),
        html.Div([
            html.Span(f"{arrow} ", style={'font-size': '24px'}),
            html.Span(f"{change_pct:+.2f}%", style={
                'font-size': '28px',
                'font-weight': 'bold',
                'color': color
            })
        ], style={'margin': '10px 0'}),
        html.P(f"ç›®å‰åƒ¹æ ¼: {current_price:.2f}", style={'margin': '5px 0'}),
        html.P(f"é æ¸¬åƒ¹æ ¼: {predicted_price:.2f}", style={'margin': '5px 0'}),
        html.P(f"ä¿¡å¿ƒåº¦: {confidence:.1%}", style={'margin': '5px 0', 'font-size': '14px'})
    ], style={
        'background': 'rgba(255,255,255,0.1)',
        'padding': '20px',
        'border-radius': '10px',
        'border': '1px solid rgba(255,255,255,0.2)'
    })

    # å»ºç«‹é æ¸¬è¶¨å‹¢åœ–
    fig = go.Figure()

    # æ­·å²åƒ¹æ ¼ (æœ€è¿‘30å¤©)
    recent_data = data.tail(30)
    fig.add_trace(go.Scatter(
        x=recent_data.index,
        y=recent_data['Close'],
        mode='lines',
        name='æ­·å²åƒ¹æ ¼',
        line=dict(color='#FFA726', width=2)
    ))

    # é æ¸¬é»
    future_date = recent_data.index[-1] + timedelta(days=predict_days)
    fig.add_trace(go.Scatter(
        x=[recent_data.index[-1], future_date],
        y=[current_price, predicted_price],
        mode='lines+markers',
        name=f'{predict_days}æ—¥é æ¸¬',
        line=dict(color=color, width=3, dash='dash'),
        marker=dict(size=8)
    ))

    fig.update_layout(
        title=f'å°æŒ‡æœŸ {predict_days}æ—¥é æ¸¬èµ°å‹¢',
        xaxis_title='æ—¥æœŸ',
        yaxis_title='æŒ‡æ•¸é»ä½',
        height=350,
        plot_bgcolor='rgba(0,0,0,0)',
        paper_bgcolor='rgba(0,0,0,0)',
        font=dict(color='white')
    )

    return result_card, fig

# æ›´æ–°è‚¡åƒ¹è³‡è¨Šå¡ç‰‡
@app.callback(
    dash.dependencies.Output('stock-info-cards', 'children'),
    [dash.dependencies.Input('stock-dropdown', 'value')]
)
def update_stock_info(selected_stock):
    data = get_stock_data(selected_stock, '5d')
    if data.empty:
        return html.Div("ç„¡æ³•ç²å–è‚¡ç¥¨è³‡æ–™")

    current_price = data['Close'].iloc[-1]
    prev_price = data['Close'].iloc[-2] if len(data) > 1 else current_price
    change = current_price - prev_price
    change_pct = (change / prev_price) * 100

    # æ‰¾å‡ºè‚¡ç¥¨ä¸­æ–‡åç¨±
    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    color = 'green' if change >= 0 else 'red'

    return html.Div([
        html.Div([
            html.H3(f"{stock_name} ({selected_stock})", style={'margin': '0'}),
            html.H2(f"${current_price:.2f}", style={'margin': '5px 0', 'color': color}),
            html.P(f"{'â–²' if change >= 0 else 'â–¼'} {change:+.2f} ({change_pct:+.2f}%)",
                   style={'margin': '0', 'color': color, 'font-weight': 'bold'})
        ], style={
            'background': 'white',
            'padding': '20px',
            'border-radius': '10px',
            'box-shadow': '0 2px 10px rgba(0,0,0,0.1)',
            'display': 'inline-block',
            'margin-right': '20px'
        }),

        html.Div([
            html.H4("ä»Šæ—¥çµ±è¨ˆ", style={'margin': '0 0 10px 0'}),
            html.P(f"æœ€é«˜: ${data['High'].iloc[-1]:.2f}", style={'margin': '5px 0'}),
            html.P(f"æœ€ä½: ${data['Low'].iloc[-1]:.2f}", style={'margin': '5px 0'}),
            html.P(f"æˆäº¤é‡: {data['Volume'].iloc[-1]:,.0f}", style={'margin': '5px 0'})
        ], style={
            'background': 'white',
            'padding': '20px',
            'border-radius': '10px',
            'box-shadow': '0 2px 10px rgba(0,0,0,0.1)',
            'display': 'inline-block'
        })
    ])

# æ›´æ–°è‚¡åƒ¹åœ–è¡¨
@app.callback(
    dash.dependencies.Output('price-chart', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value'),
     dash.dependencies.Input('period-dropdown', 'value'),
     dash.dependencies.Input('chart-type', 'value')]
)
def update_price_chart(selected_stock, period, chart_type):
    data = get_stock_data(selected_stock, period)
    if data.empty:
        return {}

    data = calculate_technical_indicators(data)
    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    if chart_type == 'candlestick':
        fig = go.Figure(data=go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name=stock_name
        ))
    else:
        fig = px.line(data, y='Close', title=f'{stock_name} è‚¡åƒ¹èµ°å‹¢')

    # æ·»åŠ ç§»å‹•å¹³å‡ç·š
    fig.add_trace(go.Scatter(x=data.index, y=data['MA5'], mode='lines', name='MA5', line=dict(color='orange')))
    fig.add_trace(go.Scatter(x=data.index, y=data['MA20'], mode='lines', name='MA20', line=dict(color='blue')))

    fig.update_layout(
        title=f'{stock_name} è‚¡åƒ¹èµ°å‹¢',
        xaxis_title='æ—¥æœŸ',
        yaxis_title='åƒ¹æ ¼ (TWD)',
        height=400
    )

    return fig

# æ›´æ–°RSIåœ–è¡¨ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
@app.callback(
    dash.dependencies.Output('rsi-chart', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value'),
     dash.dependencies.Input('period-dropdown', 'value')]
)
def update_rsi_chart(selected_stock, period):
    data = get_stock_data(selected_stock, period)
    if data.empty:
        return {}

    data = calculate_technical_indicators(data)

    fig = go.Figure()
    fig.add_trace(go.Scatter(x=data.index, y=data['RSI'], mode='lines', name='RSI', line=dict(color='purple', width=2)))
    fig.add_hline(y=70, line_dash="dash", line_color="red", annotation_text="è¶…è²·ç·š(70)")
    fig.add_hline(y=30, line_dash="dash", line_color="green", annotation_text="è¶…è³£ç·š(30)")
    fig.add_hline(y=50, line_dash="dot", line_color="gray", annotation_text="ä¸­ç·š(50)")

    # æ·»åŠ è¶…è²·è¶…è³£å€åŸŸèƒŒæ™¯
    fig.add_hrect(y0=70, y1=100, fillcolor="red", opacity=0.1, annotation_text="è¶…è²·å€")
    fig.add_hrect(y0=0, y1=30, fillcolor="green", opacity=0.1, annotation_text="è¶…è³£å€")

    fig.update_layout(
        title='RSI ç›¸å°å¼·å¼±æŒ‡æ¨™',
        xaxis_title='æ—¥æœŸ',
        yaxis_title='RSI',
        height=400,
        yaxis=dict(range=[0, 100])
    )

    return fig

# æ–°å¢ï¼šé€²éšæŠ€è¡“æŒ‡æ¨™åœ–è¡¨
@app.callback(
    dash.dependencies.Output('advanced-technical-chart', 'figure'),
    [dash.dependencies.Input('technical-indicator-selector', 'value'),
     dash.dependencies.Input('stock-dropdown', 'value'),
     dash.dependencies.Input('period-dropdown', 'value')]
)
def update_advanced_technical_chart(indicator, selected_stock, period):
    data = get_stock_data(selected_stock, period)
    if data.empty:
        return {}

    data = calculate_technical_indicators(data)
    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    if indicator == 'RSI':
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=data.index, y=data['RSI'], mode='lines', name='RSI', line=dict(color='purple', width=2)))
        fig.add_hline(y=70, line_dash="dash", line_color="red", annotation_text="è¶…è²·ç·š(70)")
        fig.add_hline(y=30, line_dash="dash", line_color="green", annotation_text="è¶…è³£ç·š(30)")
        fig.add_hline(y=50, line_dash="dot", line_color="gray", annotation_text="ä¸­ç·š(50)")

        fig.add_hrect(y0=70, y1=100, fillcolor="red", opacity=0.1)
        fig.add_hrect(y0=0, y1=30, fillcolor="green", opacity=0.1)

        fig.update_layout(
            title=f'{stock_name} - RSI ç›¸å°å¼·å¼±æŒ‡æ¨™',
            xaxis_title='æ—¥æœŸ',
            yaxis_title='RSI',
            height=450,
            yaxis=dict(range=[0, 100])
        )

    elif indicator == 'MACD':
        fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                           vertical_spacing=0.1,
                           row_heights=[0.7, 0.3],
                           subplot_titles=('åƒ¹æ ¼èˆ‡MACDç·š', 'MACDæŸ±ç‹€åœ–'))

        # ä¸Šæ–¹ï¼šåƒ¹æ ¼ç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['Close'], mode='lines', name='æ”¶ç›¤åƒ¹',
                                line=dict(color='black', width=1)), row=1, col=1)

        # MACDç·šå’Œä¿¡è™Ÿç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['MACD'], mode='lines', name='MACD',
                                line=dict(color='blue', width=2)), row=1, col=1)
        fig.add_trace(go.Scatter(x=data.index, y=data['MACD_Signal'], mode='lines', name='ä¿¡è™Ÿç·š',
                                line=dict(color='red', width=2)), row=1, col=1)

        # ä¸‹æ–¹ï¼šMACDæŸ±ç‹€åœ–
        colors = ['green' if x >= 0 else 'red' for x in data['MACD_Histogram']]
        fig.add_trace(go.Bar(x=data.index, y=data['MACD_Histogram'], name='MACDæŸ±ç‹€åœ–',
                            marker_color=colors), row=2, col=1)

        fig.add_hline(y=0, line_dash="dash", line_color="gray", row=1, col=1)
        fig.add_hline(y=0, line_dash="dash", line_color="gray", row=2, col=1)

        fig.update_layout(
            title=f'{stock_name} - MACD æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š',
            height=500
        )

    elif indicator == 'BB':
        fig = go.Figure()

        # åƒ¹æ ¼ç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['Close'], mode='lines', name='æ”¶ç›¤åƒ¹',
                                line=dict(color='black', width=2)))

        # å¸ƒæ—é€šé“ä¸Šè»Œ
        fig.add_trace(go.Scatter(x=data.index, y=data['BB_Upper'], mode='lines', name='ä¸Šè»Œ',
                                line=dict(color='red', width=1, dash='dash')))

        # å¸ƒæ—é€šé“ä¸­è»Œ
        fig.add_trace(go.Scatter(x=data.index, y=data['BB_Middle'], mode='lines', name='ä¸­è»Œ(MA20)',
                                line=dict(color='blue', width=1)))

        # å¸ƒæ—é€šé“ä¸‹è»Œ
        fig.add_trace(go.Scatter(x=data.index, y=data['BB_Lower'], mode='lines', name='ä¸‹è»Œ',
                                line=dict(color='green', width=1, dash='dash')))

        # å¡«å……é€šé“å€åŸŸ
        fig.add_trace(go.Scatter(x=data.index, y=data['BB_Upper'], mode='lines',
                                line=dict(color='rgba(0,0,0,0)'), showlegend=False))
        fig.add_trace(go.Scatter(x=data.index, y=data['BB_Lower'], mode='lines',
                                fill='tonexty', fillcolor='rgba(173,216,230,0.2)',
                                line=dict(color='rgba(0,0,0,0)'), name='å¸ƒæ—é€šé“', showlegend=False))

        fig.update_layout(
            title=f'{stock_name} - å¸ƒæ—é€šé“ (20æ—¥, 2Ïƒ)',
            xaxis_title='æ—¥æœŸ',
            yaxis_title='åƒ¹æ ¼ (TWD)',
            height=450
        )

    elif indicator == 'KD':
        fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                           vertical_spacing=0.1,
                           row_heights=[0.6, 0.4],
                           subplot_titles=('åƒ¹æ ¼èµ°å‹¢', 'KDæŒ‡æ¨™'))

        # ä¸Šæ–¹ï¼šåƒ¹æ ¼ç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['Close'], mode='lines', name='æ”¶ç›¤åƒ¹',
                                line=dict(color='black', width=1)), row=1, col=1)

        # ä¸‹æ–¹ï¼šKDç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['K'], mode='lines', name='Kç·š',
                                line=dict(color='blue', width=2)), row=2, col=1)
        fig.add_trace(go.Scatter(x=data.index, y=data['D'], mode='lines', name='Dç·š',
                                line=dict(color='red', width=2)), row=2, col=1)

        # KDæŒ‡æ¨™åƒè€ƒç·š
        fig.add_hline(y=80, line_dash="dash", line_color="red", annotation_text="è¶…è²·ç·š(80)", row=2, col=1)
        fig.add_hline(y=20, line_dash="dash", line_color="green", annotation_text="è¶…è³£ç·š(20)", row=2, col=1)
        fig.add_hline(y=50, line_dash="dot", line_color="gray", annotation_text="ä¸­ç·š(50)", row=2, col=1)

        # è¶…è²·è¶…è³£å€åŸŸ
        fig.add_hrect(y0=80, y1=100, fillcolor="red", opacity=0.1, row=2, col=1)
        fig.add_hrect(y0=0, y1=20, fillcolor="green", opacity=0.1, row=2, col=1)

        fig.update_layout(
            title=f'{stock_name} - KD éš¨æ©ŸæŒ‡æ¨™ (9,3,3)',
            height=500
        )
        fig.update_yaxes(range=[0, 100], row=2, col=1)

    elif indicator == 'WR':
        fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                           vertical_spacing=0.1,
                           row_heights=[0.6, 0.4],
                           subplot_titles=('åƒ¹æ ¼èµ°å‹¢', 'å¨å»‰æŒ‡æ¨™ %R'))

        # ä¸Šæ–¹ï¼šåƒ¹æ ¼ç·š
        fig.add_trace(go.Scatter(x=data.index, y=data['Close'], mode='lines', name='æ”¶ç›¤åƒ¹',
                                line=dict(color='black', width=1)), row=1, col=1)

        # ä¸‹æ–¹ï¼šå¨å»‰æŒ‡æ¨™
        fig.add_trace(go.Scatter(x=data.index, y=data['Williams_R'], mode='lines', name='å¨å»‰%R',
                                line=dict(color='purple', width=2)), row=2, col=1)

        # å¨å»‰æŒ‡æ¨™åƒè€ƒç·š
        fig.add_hline(y=-20, line_dash="dash", line_color="red", annotation_text="è¶…è²·ç·š(-20)", row=2, col=1)
        fig.add_hline(y=-80, line_dash="dash", line_color="green", annotation_text="è¶…è³£ç·š(-80)", row=2, col=1)
        fig.add_hline(y=-50, line_dash="dot", line_color="gray", annotation_text="ä¸­ç·š(-50)", row=2, col=1)

        # è¶…è²·è¶…è³£å€åŸŸ
        fig.add_hrect(y0=-20, y1=0, fillcolor="red", opacity=0.1, row=2, col=1)
        fig.add_hrect(y0=-100, y1=-80, fillcolor="green", opacity=0.1, row=2, col=1)

        fig.update_layout(
            title=f'{stock_name} - å¨å»‰æŒ‡æ¨™ %R (14æ—¥)',
            height=500
        )
        fig.update_yaxes(range=[-100, 0], row=2, col=1)

    return fig

# æ›´æ–°æˆäº¤é‡åœ–è¡¨
@app.callback(
    dash.dependencies.Output('volume-chart', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value'),
     dash.dependencies.Input('period-dropdown', 'value')]
)
def update_volume_chart(selected_stock, period):
    data = get_stock_data(selected_stock, period)
    if data.empty:
        return {}

    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    fig = px.bar(data, y='Volume', title=f'{stock_name} æˆäº¤é‡')
    fig.update_layout(
        xaxis_title='æ—¥æœŸ',
        yaxis_title='æˆäº¤é‡',
        height=300
    )

    return fig

# æ›´æ–°ç”¢æ¥­åˆ†æåœ–è¡¨
@app.callback(
    dash.dependencies.Output('industry-analysis', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value')]
)
def update_industry_analysis(selected_stock):
    # ç²å–å¤šæª”è‚¡ç¥¨è³‡æ–™é€²è¡Œç”¢æ¥­æ¯”è¼ƒ
    industry_data = []

    for symbol in list(TAIWAN_STOCKS.values())[:10]:  # å–å‰10æª”åšç¤ºç¯„
        data = get_stock_data(symbol, '1mo')
        if not data.empty:
            stock_name = [name for name, symbol_code in TAIWAN_STOCKS.items() if symbol_code == symbol][0]
            latest_price = data['Close'].iloc[-1]
            first_price = data['Close'].iloc[0]
            return_pct = ((latest_price - first_price) / first_price) * 100

            industry_data.append({
                'è‚¡ç¥¨': stock_name,
                'ä»£ç¢¼': symbol,
                'æœˆå ±é…¬ç‡(%)': return_pct,
                'ç”¢æ¥­': INDUSTRY_MAPPING.get(symbol, 'å…¶ä»–')
            })

    if not industry_data:
        return {}

    df_industry = pd.DataFrame(industry_data)

    # å»ºç«‹ç”¢æ¥­è¡¨ç¾åœ“é¤…åœ–
    fig = px.pie(df_industry, values='æœˆå ±é…¬ç‡(%)', names='è‚¡ç¥¨',
                title='å„è‚¡ç¥¨æœˆå ±é…¬ç‡æ¯”è¼ƒ',
                color_discrete_sequence=px.colors.qualitative.Set3)

    fig.update_layout(height=400)
    return fig

# æ–°å¢ï¼šæ›´æ–°æ™¯æ°£ç‡ˆè™Ÿåœ–è¡¨
@app.callback(
    dash.dependencies.Output('business-climate-chart', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value')]  # é›–ç„¶ä¸æœƒå½±éŸ¿åœ–è¡¨ï¼Œä½†éœ€è¦è§¸ç™¼
)
def update_business_climate_chart(selected_stock):
    df = get_business_climate_data()

    if df.empty:
        # å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºåœ–è¡¨
        fig = go.Figure()
        fig.add_annotation(
            x=0.5, y=0.5,
            text="ç„¡æ³•è¼‰å…¥æ™¯æ°£ç‡ˆè™Ÿè³‡æ–™<br>è«‹ç¢ºèª business_climate.csv æª”æ¡ˆæ˜¯å¦å­˜åœ¨",
            xref="paper", yref="paper",
            showarrow=False,
            font=dict(size=14)
        )
        fig.update_layout(
            title="å°ç£æ™¯æ°£ç‡ˆè™Ÿ",
            height=300,
            showlegend=False
        )
        return fig

    # å®šç¾©ç‡ˆè™Ÿé¡è‰²
    def get_light_color(score):
        if score >= 32:
            return 'red'      # ç´…ç‡ˆ
        elif score >= 24:
            return 'orange'   # é»ƒç´…ç‡ˆ
        elif score >= 17:
            return 'yellow'   # é»ƒç‡ˆ
        elif score >= 10:
            return 'lightgreen'  # é»ƒè—ç‡ˆ
        else:
            return 'blue'     # è—ç‡ˆ

    # ç‚ºæ¯å€‹é»è¨­å®šé¡è‰²
    colors = [get_light_color(score) for score in df['Index']]

    fig = go.Figure()

    fig.add_trace(go.Scatter(
        x=df['Date'],
        y=df['Index'],
        mode='lines+markers',
        name='æ™¯æ°£ç‡ˆè™Ÿ',
        line=dict(color='darkblue', width=2),
        marker=dict(
            size=8,
            color=colors,
            line=dict(width=2, color='darkblue')
        )
    ))

    # æ·»åŠ ç‡ˆè™Ÿå€é–“ç·š
    fig.add_hline(y=32, line_dash="dash", line_color="red", annotation_text="ç´…ç‡ˆ(32)")
    fig.add_hline(y=24, line_dash="dash", line_color="orange", annotation_text="é»ƒç´…ç‡ˆ(24)")
    fig.add_hline(y=17, line_dash="dash", line_color="yellow", annotation_text="é»ƒç‡ˆ(17)")
    fig.add_hline(y=10, line_dash="dash", line_color="lightgreen", annotation_text="é»ƒè—ç‡ˆ(10)")

    fig.update_layout(
        title="å°ç£æ™¯æ°£ç‡ˆè™Ÿèµ°å‹¢",
        xaxis_title='æ—¥æœŸ',
        yaxis_title='ç‡ˆè™Ÿåˆ†æ•¸',
        height=300,
        yaxis=dict(range=[0, 40])
    )

    return fig

# æ–°å¢ï¼šæ›´æ–°åˆ†æå¸«è§€é»
@app.callback(
    [dash.dependencies.Output('technical-analysis-text', 'children'),
     dash.dependencies.Output('fundamental-analysis-text', 'children'),
     dash.dependencies.Output('market-outlook-text', 'children')],
    [dash.dependencies.Input('stock-dropdown', 'value'),
     dash.dependencies.Input('period-dropdown', 'value')]
)
def update_analysis_text(selected_stock, period):
    # ç²å–è‚¡ç¥¨è³‡æ–™é€²è¡Œåˆ†æ
    data = get_stock_data(selected_stock, period)
    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    if data.empty:
        return "ç„¡æ³•ç²å–è³‡æ–™é€²è¡Œåˆ†æ", "ç„¡æ³•ç²å–è³‡æ–™é€²è¡Œåˆ†æ", "ç„¡æ³•ç²å–è³‡æ–™é€²è¡Œåˆ†æ"

    # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    data = calculate_technical_indicators(data)

    # åŸºæœ¬æ•¸æ“š
    current_price = data['Close'].iloc[-1]
    price_change = ((current_price - data['Close'].iloc[0]) / data['Close'].iloc[0]) * 100
    volume_avg = data['Volume'].mean()
    recent_volume = data['Volume'].iloc[-5:].mean()
    rsi_current = data['RSI'].iloc[-1] if not pd.isna(data['RSI'].iloc[-1]) else 50

    # æ–°å¢æŠ€è¡“æŒ‡æ¨™æ•¸æ“š
    macd_current = data['MACD'].iloc[-1] if not pd.isna(data['MACD'].iloc[-1]) else 0
    macd_signal_current = data['MACD_Signal'].iloc[-1] if not pd.isna(data['MACD_Signal'].iloc[-1]) else 0
    bb_position = data['BB_Position'].iloc[-1] if not pd.isna(data['BB_Position'].iloc[-1]) else 0.5
    k_current = data['K'].iloc[-1] if not pd.isna(data['K'].iloc[-1]) else 50
    d_current = data['D'].iloc[-1] if not pd.isna(data['D'].iloc[-1]) else 50

    # æŠ€è¡“é¢åˆ†æ
    technical_text = html.Div([
        html.P([
            html.Strong("åƒ¹æ ¼è¶¨å‹¢ï¼š"),
            f"è¿‘æœŸ{period}æœŸé–“å…§ï¼Œ{stock_name}å‘ˆç¾",
            html.Span(f"{'ä¸Šæ¼²' if price_change > 5 else 'ä¸‹è·Œ' if price_change < -5 else 'ç›¤æ•´'}",
                     style={'color': 'green' if price_change > 5 else 'red' if price_change < -5 else 'orange', 'font-weight': 'bold'}),
            f"èµ°å‹¢ï¼Œç´¯è¨ˆè®Šå‹•{price_change:+.1f}%ã€‚"
        ]),
        html.P([
            html.Strong("RSIæŒ‡æ¨™ï¼š"),
            f"ç›®å‰ç‚º{rsi_current:.1f}ï¼Œ",
            html.Span(
                "è™•æ–¼è¶…è²·å€é–“" if rsi_current > 70 else "è™•æ–¼è¶…è³£å€é–“" if rsi_current < 30 else "åœ¨æ­£å¸¸ç¯„åœå…§",
                style={'color': 'red' if rsi_current > 70 else 'green' if rsi_current < 30 else 'blue', 'font-weight': 'bold'}
            ),
            "ã€‚"
        ]),
        html.P([
            html.Strong("MACDæŒ‡æ¨™ï¼š"),
            f"MACDç·š({macd_current:.3f})",
            html.Span(
                "é«˜æ–¼" if macd_current > macd_signal_current else "ä½æ–¼",
                style={'color': 'green' if macd_current > macd_signal_current else 'red', 'font-weight': 'bold'}
            ),
            f"ä¿¡è™Ÿç·š({macd_signal_current:.3f})ï¼Œ",
            f"é¡¯ç¤º{'å¤šé ­' if macd_current > macd_signal_current else 'ç©ºé ­'}æ ¼å±€ã€‚"
        ]),
        html.P([
            html.Strong("å¸ƒæ—é€šé“ï¼š"),
            f"è‚¡åƒ¹ä½æ–¼é€šé“",
            html.Span(
                "ä¸ŠåŠéƒ¨" if bb_position > 0.8 else "ä¸‹åŠéƒ¨" if bb_position < 0.2 else "ä¸­æ®µ",
                style={'color': 'red' if bb_position > 0.8 else 'green' if bb_position < 0.2 else 'blue', 'font-weight': 'bold'}
            ),
            f"({bb_position*100:.0f}%)ï¼Œ",
            f"{'å£“åŠ›è¼ƒå¤§' if bb_position > 0.8 else 'æ”¯æ’è¼ƒå¼·' if bb_position < 0.2 else 'æ•´ç†æ ¼å±€'}ã€‚"
        ]),
        html.P([
            html.Strong("KDæŒ‡æ¨™ï¼š"),
            f"Kå€¼({k_current:.1f})",
            html.Span(
                "é«˜æ–¼" if k_current > d_current else "ä½æ–¼",
                style={'color': 'green' if k_current > d_current else 'red', 'font-weight': 'bold'}
            ),
            f"Då€¼({d_current:.1f})ï¼Œ",
            html.Span(
                "è¶…è²·è­¦æˆ’" if k_current > 80 else "è¶…è³£é—œæ³¨" if k_current < 20 else "æ­£å¸¸å€é–“",
                style={'color': 'red' if k_current > 80 else 'green' if k_current < 20 else 'blue', 'font-weight': 'bold'}
            ),
            "ã€‚"
        ]),
        html.P([
            html.Strong("æˆäº¤é‡åˆ†æï¼š"),
            f"è¿‘æœŸæˆäº¤é‡{'æ”¾å¤§' if recent_volume > volume_avg * 1.2 else 'èç¸®' if recent_volume < volume_avg * 0.8 else 'å¹³ç©©'}ï¼Œ",
            f"é¡¯ç¤ºå¸‚å ´{'é—œæ³¨åº¦æå‡' if recent_volume > volume_avg * 1.2 else 'è§€æœ›æ°£æ°›æ¿ƒåš' if recent_volume < volume_avg * 0.8 else 'äº¤æŠ•æ­£å¸¸'}ã€‚"
        ])
    ])

    # åŸºæœ¬é¢åˆ†æ
    industry = INDUSTRY_MAPPING.get(selected_stock, 'ç¶œåˆ')
    if selected_stock == 'TXF=F':
        fundamental_text = html.Div([
            html.P([
                html.Strong("ç¸½é«”ç¶“æ¿Ÿï¼š"),
                "å°æŒ‡æœŸåæ˜ å°è‚¡æ•´é«”è¡¨ç¾ï¼Œç•¶å‰éœ€é—œæ³¨è¯æº–æœƒæ”¿ç­–ã€åœ‹éš›è²¿æ˜“æƒ…å‹¢åŠå°ç£å‡ºå£å‹•èƒ½ã€‚"
            ]),
            html.P([
                html.Strong("ç”¢æ¥­è¼ªå‹•ï¼š"),
                "è§€å¯ŸåŠå°é«”ã€é›»å­ç­‰æ¬Šé‡ç”¢æ¥­è¡¨ç¾ï¼Œä»¥åŠå‚³çµ±ç”¢æ¥­å¾©ç”¦åŠ›é“ã€‚"
            ]),
            html.P([
                html.Strong("è³‡é‡‘é¢ï¼š"),
                "å¤–è³‡å‹•å‘ã€åŒ¯ç‡è®ŠåŒ–åŠå¸‚å ´æµå‹•æ€§ç‚ºä¸»è¦è§€å¯Ÿé‡é»ã€‚"
            ])
        ])
    else:
        fundamental_text = html.Div([
            html.P([
                html.Strong("ç”¢æ¥­åœ°ä½ï¼š"),
                f"{stock_name}å±¬æ–¼{industry}ç”¢æ¥­ï¼Œåœ¨ç”¢æ¥­éˆä¸­å…·æœ‰",
                html.Span("é‡è¦åœ°ä½" if selected_stock in ['2330.TW', '2454.TW', '2317.TW'] else "ä¸€å®šå½±éŸ¿åŠ›",
                         style={'font-weight': 'bold'}),
                "ã€‚"
            ]),
            html.P([
                html.Strong("ç‡Ÿé‹å±•æœ›ï¼š"),
                f"è€ƒé‡{industry}ç”¢æ¥­å‰æ™¯åŠå…¬å¸åŸºæœ¬é¢ï¼Œå»ºè­°æŒçºŒé—œæ³¨å­£å ±è¡¨ç¾åŠæœªä¾†æŒ‡å¼•ã€‚"
            ]),
            html.P([
                html.Strong("é¢¨éšªè©•ä¼°ï¼š"),
                "æ³¨æ„ç”¢æ¥­é€±æœŸæ€§è®ŠåŒ–ã€åœ‹éš›ç«¶çˆ­åŠæ³•è¦ç’°å¢ƒè®ŠåŒ–ç­‰é¢¨éšªå› å­ã€‚"
            ])
        ])

    # å¸‚å ´å±•æœ›
    if price_change > 10:
        outlook_tone = "è¬¹æ…æ¨‚è§€"
        outlook_color = "#28a745"
    elif price_change < -10:
        outlook_tone = "ä¿å®ˆè§€æœ›"
        outlook_color = "#dc3545"
    else:
        outlook_tone = "ä¸­æ€§æŒå¹³"
        outlook_color = "#ffc107"

    market_outlook = html.Div([
        html.P([
            html.Strong("æ•´é«”è©•ä¼°ï¼š", style={'font-size': '16px'}),
            f"åŸºæ–¼æŠ€è¡“é¢åŠåŸºæœ¬é¢åˆ†æï¼Œå°{stock_name}æ¡å–",
            html.Span(f"{outlook_tone}", style={'color': outlook_color, 'font-weight': 'bold', 'font-size': '16px'}),
            "æ…‹åº¦ã€‚"
        ]),
        html.P([
            html.Strong("æŠ•è³‡å»ºè­°ï¼š"),
            "å»ºè­°æŠ•è³‡äººæ ¹æ“šè‡ªèº«é¢¨éšªæ‰¿å—èƒ½åŠ›ï¼Œæ¡å–é©ç•¶çš„è³‡ç”¢é…ç½®ç­–ç•¥ã€‚çŸ­ç·šæ“ä½œæ³¨æ„æŠ€è¡“æŒ‡æ¨™ï¼Œé•·ç·šæŠ•è³‡é—œæ³¨åŸºæœ¬é¢è®ŠåŒ–ã€‚"
        ]),
        html.P([
            html.Strong("é¢¨éšªæé†’ï¼š"),
            "è‚¡ç¥¨æŠ•è³‡å…·æœ‰é¢¨éšªï¼Œéå»ç¸¾æ•ˆä¸ä»£è¡¨æœªä¾†è¡¨ç¾ï¼ŒæŠ•è³‡å‰è«‹è©³é–±å…¬é–‹èªªæ˜æ›¸ä¸¦å¯©æ…è©•ä¼°ã€‚"
        ], style={'font-style': 'italic', 'font-size': '13px'})
    ])

    return technical_text, fundamental_text, market_outlook

# æ–°å¢ï¼šæ›´æ–°PMIåœ–è¡¨
@app.callback(
    dash.dependencies.Output('pmi-chart', 'figure'),
    [dash.dependencies.Input('stock-dropdown', 'value')]  # é›–ç„¶ä¸æœƒå½±éŸ¿åœ–è¡¨ï¼Œä½†éœ€è¦è§¸ç™¼
)
def update_pmi_chart(selected_stock):
    df = get_pmi_data()

    if df.empty:
        # å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºåœ–è¡¨
        fig = go.Figure()
        fig.add_annotation(
            x=0.5, y=0.5,
            text="ç„¡æ³•è¼‰å…¥PMIè³‡æ–™<br>è«‹ç¢ºèª taiwan_pmi.csv æª”æ¡ˆæ˜¯å¦å­˜åœ¨",
            xref="paper", yref="paper",
            showarrow=False,
            font=dict(size=14)
        )
        fig.update_layout(
            title="å°ç£PMIæŒ‡æ•¸",
            height=300,
            showlegend=False
        )
        return fig

    # å®šç¾©PMIé¡è‰² (50ä»¥ä¸Šæ“´å¼µï¼Œä»¥ä¸‹ç·Šç¸®)
    def get_pmi_color(value):
        return 'green' if value >= 50 else 'red'

    colors = [get_pmi_color(value) for value in df['Index']]

    fig = go.Figure()

    fig.add_trace(go.Scatter(
        x=df['Date'],
        y=df['Index'],
        mode='lines+markers',
        name='PMIæŒ‡æ•¸',
        line=dict(color='darkblue', width=2),
        marker=dict(
            size=8,
            color=colors,
            line=dict(width=2, color='darkblue')
        )
    ))

    # æ·»åŠ æ¦®æ¯ç·š
    fig.add_hline(y=50, line_dash="dash", line_color="black", annotation_text="æ¦®æ¯ç·š(50)")

    # æ·»åŠ èƒŒæ™¯è‰²å€åŸŸ
    fig.add_hrect(
        y0=50, y1=60,
        fillcolor="lightgreen", opacity=0.2,
        annotation_text="æ“´å¼µå€é–“", annotation_position="top left"
    )
    fig.add_hrect(
        y0=40, y1=50,
        fillcolor="lightcoral", opacity=0.2,
        annotation_text="ç·Šç¸®å€é–“", annotation_position="bottom left"
    )

    fig.update_layout(
        title="å°ç£PMIæŒ‡æ•¸èµ°å‹¢",
        xaxis_title='æ—¥æœŸ',
        yaxis_title='PMIæŒ‡æ•¸',
        height=300,
        yaxis=dict(range=[35, 60])
    )

    return fig

# æ–°å¢ï¼šå¤šæª”è‚¡ç¥¨æ¯”è¼ƒ
@app.callback(
    [dash.dependencies.Output('comparison-chart', 'figure'),
     dash.dependencies.Output('comparison-table', 'children')],
    [dash.dependencies.Input('comparison-stocks', 'value'),
     dash.dependencies.Input('comparison-period', 'value')]
)
def update_comparison_analysis(selected_stocks, period):
    if not selected_stocks:
        return {}, html.Div("è«‹é¸æ“‡è¦æ¯”è¼ƒçš„è‚¡ç¥¨")

    # é™åˆ¶æœ€å¤š5æª”
    selected_stocks = selected_stocks[:5]

    fig = go.Figure()
    comparison_data = []

    for stock in selected_stocks:
        data = get_stock_data(stock, period)
        if not data.empty:
            stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == stock][0]

            # æ­£è¦åŒ–åƒ¹æ ¼ï¼ˆä»¥æœŸåˆç‚ºåŸºæº–100ï¼‰
            normalized_prices = (data['Close'] / data['Close'].iloc[0]) * 100

            fig.add_trace(go.Scatter(
                x=data.index,
                y=normalized_prices,
                mode='lines',
                name=stock_name,
                line=dict(width=2)
            ))

            # è¨ˆç®—ç¸¾æ•ˆæ•¸æ“š
            total_return = ((data['Close'].iloc[-1] / data['Close'].iloc[0]) - 1) * 100
            volatility = data['Close'].pct_change().std() * np.sqrt(252) * 100  # å¹´åŒ–æ³¢å‹•ç‡

            comparison_data.append({
                'name': stock_name,
                'return': total_return,
                'volatility': volatility,
                'current_price': data['Close'].iloc[-1]
            })

    fig.update_layout(
        title=f'è‚¡ç¥¨ç¸¾æ•ˆæ¯”è¼ƒ - {period}',
        xaxis_title='æ—¥æœŸ',
        yaxis_title='ç›¸å°ç¸¾æ•ˆ (åŸºæœŸ=100)',
        height=400,
        hovermode='x unified'
    )

    # å»ºç«‹æ¯”è¼ƒè¡¨æ ¼
    if comparison_data:
        table_rows = []
        for item in sorted(comparison_data, key=lambda x: x['return'], reverse=True):
            color = 'green' if item['return'] > 0 else 'red'
            table_rows.append(
                html.Tr([
                    html.Td(item['name'], style={'font-weight': 'bold'}),
                    html.Td(f"{item['return']:+.1f}%", style={'color': color, 'font-weight': 'bold'}),
                    html.Td(f"{item['volatility']:.1f}%"),
                    html.Td(f"${item['current_price']:.2f}")
                ])
            )

        table = html.Table([
            html.Thead([
                html.Tr([
                    html.Th("è‚¡ç¥¨", style={'text-align': 'center'}),
                    html.Th("å ±é…¬ç‡", style={'text-align': 'center'}),
                    html.Th("æ³¢å‹•ç‡", style={'text-align': 'center'}),
                    html.Th("ç¾åƒ¹", style={'text-align': 'center'})
                ])
            ]),
            html.Tbody(table_rows)
        ], style={
            'width': '100%',
            'border-collapse': 'collapse',
            'font-size': '12px'
        })

        return fig, table

    return fig, html.Div("ç„¡å¯æ¯”è¼ƒè³‡æ–™")

# æ–°å¢ï¼šå¸‚å ´æƒ…ç·’åˆ†æ
@app.callback(
    [dash.dependencies.Output('sentiment-gauge', 'children'),
     dash.dependencies.Output('news-summary', 'children')],
    [dash.dependencies.Input('stock-dropdown', 'value')]
)
def update_sentiment_analysis(selected_stock):
    # æ¨¡æ“¬æƒ…ç·’æŒ‡æ¨™ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­å¯æ¥å…¥æ–°èAPIæˆ–æƒ…ç·’åˆ†ææœå‹™ï¼‰
    sentiment_score = np.random.uniform(30, 80)  # æ¨¡æ“¬æƒ…ç·’åˆ†æ•¸ 0-100

    # å»ºç«‹æƒ…ç·’æŒ‡æ¨™åœ“å½¢åœ–
    gauge_fig = go.Figure(go.Indicator(
        mode = "gauge+number+delta",
        value = sentiment_score,
        domain = {'x': [0, 1], 'y': [0, 1]},
        title = {'text': "å¸‚å ´æƒ…ç·’æŒ‡æ•¸"},
        delta = {'reference': 50},
        gauge = {
            'axis': {'range': [None, 100]},
            'bar': {'color': "darkblue"},
            'steps': [
                {'range': [0, 30], 'color': "lightcoral"},
                {'range': [30, 70], 'color': "lightgray"},
                {'range': [70, 100], 'color': "lightgreen"}
            ],
            'threshold': {
                'line': {'color': "red", 'width': 4},
                'thickness': 0.75,
                'value': 90
            }
        }
    ))

    gauge_fig.update_layout(height=200, margin=dict(l=20, r=20, t=40, b=20))

    # æ¨¡æ“¬æ–°èæ‘˜è¦
    stock_name = [name for name, symbol in TAIWAN_STOCKS.items() if symbol == selected_stock][0]

    news_items = [
        f"ğŸ“ˆ {stock_name}ç²å¤–è³‡èª¿å‡ç›®æ¨™åƒ¹ï¼Œçœ‹å¥½å¾ŒçºŒç™¼å±•å‰æ™¯",
        f"ğŸ’¼ æ³•äººé æœŸ{stock_name}ä¸‹å­£ç‡Ÿæ”¶å°‡è¼ƒä¸Šå­£æˆé•·5-10%",
        f"ğŸŒ åœ‹éš›å¸‚å ´æ³¢å‹•å°{stock_name}å½±éŸ¿æœ‰é™ï¼ŒåŸºæœ¬é¢ç©©å¥",
        f"âš¡ ç”¢æ¥­æ™¯æ°£å›æº«ï¼Œ{stock_name}å—æƒ ç¨‹åº¦å€¼å¾—é—œæ³¨",
        f"ğŸ“Š æŠ€è¡“é¢é¡¯ç¤º{stock_name}çªç ´é—œéµå£“åŠ›ï¼ŒçŸ­ç·šåå¤š"
    ]

    news_content = html.Div([
        html.P(news, style={
            'margin': '8px 0',
            'padding': '8px',
            'background': '#e8f4f8',
            'border-radius': '5px',
            'border-left': '3px solid #17a2b8',
            'font-size': '13px'
        }) for news in news_items[:3]  # é¡¯ç¤ºå‰3æ¢
    ])

    return dcc.Graph(figure=gauge_fig), news_content

# åœ¨ Colab ä¸­åŸ·è¡Œçš„è¨­å®š
if __name__ == '__main__':
    # åœ¨åŸ·è¡Œå‰å…ˆæ¸¬è©¦æª”æ¡ˆè®€å–
    print("æ¸¬è©¦æª”æ¡ˆè®€å–...")
    business_data = get_business_climate_data()
    pmi_data = get_pmi_data()

    if not business_data.empty:
        print(f"æ™¯æ°£ç‡ˆè™Ÿè³‡æ–™é è¦½ï¼š\n{business_data.head()}")
    if not pmi_data.empty:
        print(f"PMIè³‡æ–™é è¦½ï¼š\n{pmi_data.head()}")

    # åœ¨ Colab ä¸­éœ€è¦ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å•Ÿå‹•
    app.run(mode='inline', port=8050, debug=True)

    # å¦‚æœåœ¨æœ¬åœ°ç’°å¢ƒåŸ·è¡Œï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼
    # app.run_server(debug=True)

# ä½¿ç”¨èªªæ˜ï¼š
"""
åœ¨ Google Colab ä¸­åŸ·è¡Œæ­¤ç¨‹å¼çš„æ­¥é©Ÿï¼š

1. é¦–å…ˆå®‰è£å¿…è¦å¥—ä»¶ï¼š
   !pip install dash plotly yfinance pandas numpy

2. ç¢ºä¿ä½ çš„ CSV æª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼š
   - business_climate.csv: åŒ…å« Date å’Œ Index å…©æ¬„
   - taiwan_pmi.csv: åŒ…å« DATE å’Œ INDEX å…©æ¬„ (æˆ– Date å’Œ Index)
   - æ—¥æœŸæ ¼å¼å»ºè­°ç‚º YYYY-MM (ä¾‹å¦‚: 2023-07)

3. å°‡ CSV æª”æ¡ˆä¸Šå‚³åˆ° Colab çš„æª”æ¡ˆå€åŸŸï¼Œç¢ºä¿æª”åæ­£ç¢º

4. å°‡ä¸Šè¿°ç¨‹å¼ç¢¼è²¼åˆ° Colab cell ä¸­åŸ·è¡Œ

5. ç¨‹å¼æœƒå…ˆæ¸¬è©¦æª”æ¡ˆè®€å–ï¼Œç„¶å¾Œå•Ÿå‹•å„€è¡¨æ¿

ä¿®æ­£å…§å®¹ï¼š
- æ–°å¢äº† os æ¨¡çµ„ä¾†æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
- æ”¹å–„äº† CSV æª”æ¡ˆè®€å–å‡½æ•¸ï¼ŒåŠ å…¥éŒ¯èª¤è™•ç†å’Œæ ¼å¼æª¢æŸ¥
- æ–°å¢äº†æ™¯æ°£ç‡ˆè™Ÿå’Œ PMI åœ–è¡¨çš„å›èª¿å‡½æ•¸
- ä¿®æ­£äº† dash.Output çš„èªæ³•ï¼ˆä½¿ç”¨ dash.dependencies.Outputï¼‰
- åŠ å…¥äº†æ—¥æœŸæ ¼å¼è™•ç†ï¼Œæ”¯æ´ YYYY-MM æ ¼å¼
- æ–°å¢äº†æª”æ¡ˆè®€å–æ¸¬è©¦åŠŸèƒ½

å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. CSV æª”æ¡ˆæ˜¯å¦åœ¨æ­£ç¢ºä½ç½®
2. æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º
3. æ—¥æœŸæ¬„ä½æ˜¯å¦åŒ…å«æœ‰æ•ˆæ—¥æœŸ
"""